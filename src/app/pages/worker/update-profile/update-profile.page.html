<ion-content
  [fullscreen]="true"
  class="bg-gradient-to-br from-indigo-50 via-white to-purple-50"
>
  <!-- Header -->
  <div
    class="bg-gradient-to-r from-indigo-600 via-purple-600 to-blue-600 pt-12 pb-6 px-6 shadow-xl mb-6"
  >
    <div class="flex items-center space-x-4">
      <button
        (click)="goBack()"
        class="p-2 rounded-xl bg-white/20 hover:bg-white/30 transition-all duration-200 backdrop-blur-sm"
      >
        <ion-icon name="chevron-back" class="text-white text-xl"></ion-icon>
      </button>
      <div>
        <h1 class="text-white text-2xl font-bold">Update Profile</h1>
        <p class="text-purple-100 text-sm">Keep your information up to date</p>
      </div>
    </div>
  </div>

  <!-- Profile Photo Section (Centered Circle) -->
  <div class="flex justify-center mb-8">
    <div class="relative">
      <div
        class="w-32 h-32 rounded-full overflow-hidden border-4 border-white shadow-xl"
      >
        <img
          *ngIf="selectedPhoto"
          [src]="selectedPhoto"
          alt="Profile"
          class="w-full h-full object-cover"
        />
        <div
          *ngIf="!selectedPhoto"
          class="w-full h-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center"
        >
          <ion-icon name="person" class="text-white text-4xl"></ion-icon>
        </div>
      </div>

      <input
        type="file"
        (change)="onPhotoSelected($event)"
        accept="image/*"
        class="hidden"
        #photoInput
      />
      <button
        type="button"
        (click)="photoInput.click()"
        class="absolute bottom-0 right-0 w-10 h-10 bg-indigo-600 hover:bg-indigo-700 text-white rounded-full flex items-center justify-center shadow-lg transition-all duration-200"
      >
        <ion-icon name="camera" class="text-lg"></ion-icon>
      </button>
    </div>
  </div>

  <form [formGroup]="profileForm" (ngSubmit)="saveProfile()" class="px-4 pb-6">
    <!-- Basic Information -->
    <div class="bg-white rounded-2xl shadow-lg p-6 mb-6 border border-gray-100">
      <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
        <ion-icon name="person" class="text-indigo-600 mr-2"></ion-icon>
        Basic Information
      </h2>

      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2"
            >Full Name *</label
          >
          <ion-input
            formControlName="fullName"
            placeholder="Enter your full name"
            class="border rounded-xl"
          ></ion-input>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2"
            >Phone Number *</label
          >
          <ion-input
            formControlName="phone"
            placeholder="Enter your phone number"
            class="border rounded-xl"
          ></ion-input>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2"
            >Full Address</label
          >
          <ion-textarea
            formControlName="fullAddress"
            placeholder="Enter your complete address"
            rows="3"
            class="border rounded-xl"
          ></ion-textarea>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2"
            >Bio</label
          >
          <ion-textarea
            formControlName="bio"
            placeholder="Tell clients about yourself and your experience"
            rows="4"
            class="border rounded-xl"
          ></ion-textarea>
        </div>
      </div>
    </div>

    <!-- Work Details -->
    <div class="bg-white rounded-2xl shadow-lg p-6 mb-6 border border-gray-100">
      <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
        <ion-icon name="briefcase" class="text-indigo-600 mr-2"></ion-icon>
        Work Details
      </h2>

      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2"
            >Work Radius (km)</label
          >
          <ion-range
            formControlName="workRadius"
            min="1"
            max="50"
            snaps="true"
            color="primary"
          >
            <ion-label slot="start">1km</ion-label>
            <ion-label slot="end">50km</ion-label>
          </ion-range>
          <div class="text-center mt-2">
            <span class="text-sm text-gray-600"
              >{{ profileForm.get('workRadius')?.value }}km radius</span
            >
          </div>
        </div>

        <!-- Available Days -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-3"
            >Available Days</label
          >
          <div class="grid grid-cols-2 gap-2" formArrayName="availableDays">
            <div
              *ngFor="let dayControl of availableDaysArray.controls; let i = index"
              class="flex items-center space-x-2"
            >
              <ion-checkbox
                [formControlName]="i"
                (ionChange)="onDayChange(i, $event)"
                color="primary"
              ></ion-checkbox>
              <span class="text-sm text-gray-700">{{ getDayName(i) }}</span>
            </div>
          </div>
        </div>

        <!-- Time Availability Section -->
        <div *ngIf="getSelectedDays().length > 0" class="mt-6">
          <div class="flex items-center space-x-2 mb-4">
            <ion-icon
              name="time-outline"
              class="text-indigo-600 text-xl"
            ></ion-icon>
            <h4 class="text-lg font-semibold text-gray-800">
              Time Availability
            </h4>
          </div>
          <p class="text-sm text-gray-600 mb-4">
            Set your working hours for each selected day
          </p>

          <div class="space-y-4">
            <div
              *ngFor="let day of availableDays"
              class="bg-gray-50 rounded-xl p-4 border border-gray-200"
              [class.hidden]="!isDaySelected(day.value)"
            >
              <div class="flex items-center justify-between mb-3">
                <div class="flex items-center space-x-3">
                  <div class="w-3 h-3 bg-indigo-500 rounded-full"></div>
                  <span class="font-semibold text-gray-800"
                    >{{ day.label }}</span
                  >
                </div>
              </div>

              <div class="grid grid-cols-2 gap-4">
                <!-- Start Time -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    <ion-icon
                      name="play-circle"
                      class="text-green-600 mr-1"
                    ></ion-icon>
                    Start Time
                  </label>
                  <ion-input
                    type="time"
                    [value]="getTimeAvailability(day.value).startTime"
                    (ionInput)="updateTimeAvailability(day.value, 'startTime', $event.detail.value!)"
                    fill="outline"
                    class="w-full border rounded-xl"
                  ></ion-input>
                </div>

                <!-- End Time -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    <ion-icon
                      name="stop-circle"
                      class="text-red-500 mr-1"
                    ></ion-icon>
                    End Time
                  </label>
                  <ion-input
                    type="time"
                    [value]="getTimeAvailability(day.value).endTime"
                    (ionInput)="updateTimeAvailability(day.value, 'endTime', $event.detail.value!)"
                    fill="outline"
                    class="w-full border rounded-xl"
                  ></ion-input>
                </div>
              </div>

              <!-- Time Duration Display -->
              <div class="mt-3 text-center">
                <div
                  class="inline-flex items-center space-x-2 bg-blue-50 text-blue-800 px-3 py-1 rounded-full text-xs font-medium"
                >
                  <ion-icon name="time" class="text-blue-600"></ion-icon>
                  <span>
                    {{ getTimeAvailability(day.value).startTime }} - {{
                    getTimeAvailability(day.value).endTime }}
                  </span>
                </div>
              </div>
            </div>
          </div>

          <!-- Time Availability Tip -->
          <div class="bg-blue-50 rounded-xl p-4 border border-blue-200 mt-4">
            <div class="flex items-center space-x-2">
              <ion-icon
                name="information-circle"
                class="text-blue-500"
              ></ion-icon>
              <p class="text-sm text-blue-800">
                <strong>Tip:</strong> You can set different working hours for
                each day. Standard business hours (8 AM - 5 PM) are set by
                default.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Skills (Read-Only) -->
    <div class="bg-white rounded-2xl shadow-lg p-6 mb-6 border border-gray-100">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold text-gray-800 flex items-center">
          <ion-icon name="construct" class="text-indigo-600 mr-2"></ion-icon>
          Skills & Services (Read-Only)
        </h2>
        <div class="flex items-center text-sm text-gray-500">
          <ion-icon name="lock-closed-outline" class="mr-1"></ion-icon>
          Contact admin to modify
        </div>
      </div>

      <div class="space-y-3" formArrayName="skills">
        <div
          *ngFor="let skillControl of skillsArray.controls; let i = index"
          class="flex items-center space-x-3"
        >
          <ion-input
            [formControlName]="i"
            [readonly]="true"
            class="flex-1 border rounded-xl bg-gray-50"
          ></ion-input>
          <div class="w-10 h-10 flex items-center justify-center text-gray-400">
            <ion-icon name="lock-closed-outline"></ion-icon>
          </div>
        </div>
      </div>

      <div
        *ngIf="skillsArray.length === 0"
        class="text-center text-gray-500 py-4"
      >
        <p class="text-sm">
          No skills assigned yet. Contact admin to add services.
        </p>
      </div>

      <div class="mt-3 p-3 bg-amber-50 border border-amber-200 rounded-lg">
        <p class="text-sm text-amber-700 flex items-center">
          <ion-icon
            name="information-circle"
            class="mr-2 text-amber-600"
          ></ion-icon>
          Skills and services are managed by administrators. Contact support to
          request changes.
        </p>
      </div>
    </div>

    <!-- Service With Pricing (Price editing only) -->
    <div class="bg-white rounded-2xl shadow-lg p-6 mb-6 border border-gray-100">
      <div class="mb-4">
        <h2 class="text-xl font-bold text-gray-800 flex items-center">
          <ion-icon name="cash" class="text-indigo-600 mr-2"></ion-icon>
          Service Pricing (Edit Prices Only)
        </h2>
        <p class="text-sm text-gray-600 mt-1">
          Update your pricing for existing services (categories cannot be
          added/removed)
        </p>
        <div class="mt-2 p-3 bg-blue-50 border border-blue-200 rounded-lg">
          <p class="text-sm text-blue-700 flex items-center">
            <ion-icon
              name="information-circle"
              class="mr-2 text-blue-500"
            ></ion-icon>
            You can only edit prices for your assigned services.
            <strong class="ml-1"
              >Contact admin to add/remove service categories.</strong
            >
          </p>
        </div>
      </div>

      <div class="space-y-4" formArrayName="serviceWithPricing">
        <div
          *ngFor="let svcCtrl of serviceWithPricingArray.controls; let i = index"
          [formGroupName]="i"
          class="bg-gray-50 rounded-xl p-4 border border-gray-200"
        >
          <div class="mb-3 flex items-center justify-between">
            <div class="flex items-center">
              <div
                class="w-10 h-10 rounded-lg flex items-center justify-center mr-3"
                [ngClass]="getCategoryColor(svcCtrl.get('categoryName')?.value)"
              >
                <ion-icon
                  [name]="getCategoryIcon(svcCtrl.get('categoryName')?.value)"
                  class="text-white text-lg"
                ></ion-icon>
              </div>
              <div>
                <h3 class="font-semibold text-gray-800">
                  {{ svcCtrl.get('categoryName')?.value }}
                </h3>
                <p class="text-sm text-gray-600">Assigned service category</p>
              </div>
            </div>
            <div class="flex items-center text-sm text-gray-500">
              <ion-icon name="lock-closed-outline" class="mr-1"></ion-icon>
              Fixed category
            </div>
          </div>

          <div formArrayName="subServices" class="space-y-3">
            <div
              *ngFor="let subCtrl of getSubServicesArray(svcCtrl).controls; let j = index"
              [formGroupName]="j"
              class="bg-white p-3 rounded-lg border border-gray-200"
            >
              <div class="flex items-center justify-between">
                <div class="flex-1">
                  <label
                    class="text-sm font-medium text-gray-700 flex items-center"
                  >
                    {{ subCtrl.get('subServiceName')?.value }}
                    <ion-icon
                      name="lock-closed-outline"
                      class="ml-2 text-gray-400 text-xs"
                    ></ion-icon>
                  </label>
                  <div class="text-xs text-gray-500 mt-1">
                    Unit: {{ getDisplayUnit(subCtrl.get('unit')?.value) }}
                  </div>
                </div>
                <div class="w-48 flex items-center space-x-2">
                  <span class="text-sm text-gray-500">₱</span>
                  <ion-input
                    formControlName="price"
                    type="number"
                    class="text-right flex-1"
                    min="0"
                    step="0.01"
                    placeholder="0.00"
                  ></ion-input>
                  <span class="text-sm text-gray-600 font-medium min-w-0">
                    {{ getDisplayUnit(subCtrl.get('unit')?.value) }}
                  </span>
                </div>
              </div>

              <!-- Price Preview -->
              <div
                *ngIf="subCtrl.get('price')?.value > 0"
                class="mt-2 text-right"
              >
                <span
                  class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800"
                >
                  ₱{{ subCtrl.get('price')?.value | number:'1.2-2' }}{{
                  getDisplayUnit(subCtrl.get('unit')?.value) }}
                </span>
              </div>
            </div>
            <div
              *ngIf="getSubServicesArray(svcCtrl).length === 0"
              class="text-center text-gray-500 py-2"
            >
              No sub-services for selected category
            </div>
          </div>
        </div>
      </div>

      <div
        *ngIf="serviceWithPricingArray.length === 0"
        class="text-center text-gray-500 py-8"
      >
        <div
          class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3"
        >
          <ion-icon
            name="cash-outline"
            class="text-2xl text-gray-400"
          ></ion-icon>
        </div>
        <p class="text-sm">No service pricing configured yet.</p>
        <p class="text-xs text-gray-400 mt-1">
          Contact admin to set up your service categories.
        </p>
      </div>

      <!-- Disabled Add Button with Explanation -->
      <div class="mt-4">
        <div
          class="w-full bg-gray-100 text-gray-500 py-3 px-4 rounded-xl text-sm text-center border border-gray-200"
        >
          <div class="flex items-center justify-center">
            <ion-icon name="lock-closed-outline" class="mr-2"></ion-icon>
            Service categories are managed by administrators
          </div>
        </div>
      </div>
    </div>

    <!-- Emergency Contact -->
    <div class="bg-white rounded-2xl shadow-lg p-6 mb-6 border border-gray-100">
      <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
        <ion-icon name="call" class="text-indigo-600 mr-2"></ion-icon>
        Emergency Contact
      </h2>

      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2"
            >Emergency Contact Name</label
          >
          <ion-input
            formControlName="emergencyContact"
            placeholder="Enter emergency contact name"
            class="border rounded-xl"
          ></ion-input>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2"
            >Emergency Phone Number</label
          >
          <ion-input
            formControlName="emergencyPhone"
            placeholder="Enter emergency phone number"
            class="border rounded-xl"
          ></ion-input>
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="flex space-x-4 mt-8">
      <button
        type="button"
        (click)="goBack()"
        class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 py-3 px-4 rounded-xl font-semibold text-sm transition-all duration-200"
      >
        Cancel
      </button>
      <button
        type="submit"
        [disabled]="!profileForm.valid || isLoading"
        class="flex-1 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white py-3 px-4 rounded-xl font-semibold text-sm transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
      >
        <span *ngIf="!isLoading">Save Profile</span>
        <span *ngIf="isLoading" class="flex items-center justify-center">
          <ion-spinner name="crescent" class="w-4 h-4 mr-2"></ion-spinner>
          Saving...
        </span>
      </button>
    </div>
  </form>
</ion-content>
