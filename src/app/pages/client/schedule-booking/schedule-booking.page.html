<ion-content [fullscreen]="true" class="bg-gradient-to-br from-blue-50 via-white to-indigo-50">
  <!-- Header -->
  <div class="bg-gradient-to-r from-blue-600 via-indigo-600 to-purple-600 pt-12 pb-6 px-6 shadow-xl">
    <div class="flex items-center justify-between mb-4">
      <button
        (click)="goBack()"
        class="p-2 rounded-xl bg-white/20 hover:bg-white/30 transition-all duration-200 backdrop-blur-sm"
      >
        <ion-icon name="chevron-back" class="text-white text-xl"></ion-icon>
      </button>
      
      <div class="text-center flex-1">
        <h1 class="text-white text-xl font-bold">{{ getStepTitle() }}</h1>
        <p class="text-blue-100 text-sm">{{ workerName }}</p>
      </div>
      
      <div class="w-8"></div> <!-- Spacer for centering -->
    </div>

    <!-- Progress Bar -->
    <div class="bg-white/20 rounded-full h-2 mb-4">
      <div 
        class="bg-white rounded-full h-2 transition-all duration-300"
        [style.width.%]="(currentStep / totalSteps) * 100"
      ></div>
    </div>
    
    <div class="flex justify-between text-xs text-blue-100">
      <span [class]="currentStep >= 1 ? 'font-semibold' : 'opacity-60'">Service</span>
      <span [class]="currentStep >= 2 ? 'font-semibold' : 'opacity-60'">Date & Time</span>
      <span [class]="currentStep >= 3 ? 'font-semibold' : 'opacity-60'">Details</span>
      <span [class]="currentStep >= 4 ? 'font-semibold' : 'opacity-60'">Confirm</span>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="flex justify-center items-center py-20">
    <div class="text-center">
      <ion-spinner name="crescent" class="w-12 h-12 text-indigo-600 mb-4"></ion-spinner>
      <p class="text-gray-500">Loading booking information...</p>
    </div>
  </div>

  <!-- Step Content -->
  <div *ngIf="!isLoading" class="px-4 pb-24 -mt-4">
    
    <!-- Step 1: Service Selection -->
    <div *ngIf="currentStep === 1" class="space-y-4">
      <div class="bg-white rounded-2xl shadow-lg p-6 border border-gray-100">
        <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
          <ion-icon name="construct" class="text-indigo-600 mr-2"></ion-icon>
          Available Services
        </h2>
        
        <div class="space-y-3" *ngIf="availableServices.length > 0">
          <div
            *ngFor="let service of availableServices"
            (click)="selectService(service)"
            class="border-2 rounded-xl p-4 cursor-pointer transition-all duration-200 hover:shadow-md"
            [class]="selectedService?.id === service.id ? 
              'border-indigo-500 bg-indigo-50' : 
              'border-gray-200 hover:border-gray-300'"
          >
            <div class="flex items-center justify-between">
              <div class="flex-1">
                <h3 class="font-semibold text-gray-800 mb-1">{{ service.name }}</h3>
                <p class="text-sm text-gray-600 mb-2">{{ service.category }}</p>
                <p class="text-xs text-gray-500">{{ service.description }}</p>
              </div>
              <div class="text-right ml-4">
                <div class="text-lg font-bold text-indigo-600">â‚±{{ service.price }}</div>
                <div class="text-sm text-gray-500">{{ service.duration }} mins</div>
              </div>
            </div>
            
            <div 
              *ngIf="selectedService?.id === service.id"
              class="mt-3 flex items-center text-indigo-600"
            >
              <ion-icon name="checkmark-circle" class="mr-2"></ion-icon>
              <span class="text-sm font-medium">Selected</span>
            </div>
          </div>
        </div>
        
        <div *ngIf="availableServices.length === 0" class="text-center py-8">
          <ion-icon name="construct-outline" class="text-4xl text-gray-300 mb-3"></ion-icon>
          <h3 class="text-lg font-semibold text-gray-800 mb-2">No Services Available</h3>
          <p class="text-gray-600 text-sm">This worker hasn't set up any services yet.</p>
        </div>
      </div>
    </div>

    <!-- Step 2: Date and Time Selection -->
    <div *ngIf="currentStep === 2" class="space-y-4">
      <!-- Calendar -->
      <div class="bg-white rounded-2xl shadow-lg p-6 border border-gray-100">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-bold text-gray-800 flex items-center">
            <ion-icon name="calendar" class="text-indigo-600 mr-2"></ion-icon>
            Select Date
          </h2>
          <div class="flex items-center space-x-4">
            <h3 class="text-lg font-semibold text-gray-700">{{ getMonthName() }}</h3>
            <div class="flex space-x-2">
              <button
                (click)="goToPreviousMonth()"
                class="p-2 rounded-lg bg-gray-100 hover:bg-gray-200 transition-colors duration-200"
              >
                <ion-icon name="chevron-back" class="text-gray-600"></ion-icon>
              </button>
              <button
                (click)="goToNextMonth()"
                class="p-2 rounded-lg bg-gray-100 hover:bg-gray-200 transition-colors duration-200"
              >
                <ion-icon name="chevron-forward" class="text-gray-600"></ion-icon>
              </button>
            </div>
          </div>
        </div>

        <!-- Calendar Legend -->
        <div class="mb-4 flex flex-wrap gap-4 text-xs">
          <div class="flex items-center">
            <div class="w-3 h-3 bg-green-500 rounded mr-2"></div>
            <span class="text-gray-600">Available</span>
          </div>
          <div class="flex items-center">
            <div class="w-3 h-3 bg-gray-300 rounded mr-2"></div>
            <span class="text-gray-600">Unavailable</span>
          </div>
          <div class="flex items-center">
            <div class="w-3 h-3 bg-yellow-500 rounded mr-2"></div>
            <span class="text-gray-600">Has Bookings</span>
          </div>
          <div class="flex items-center">
            <div class="w-3 h-3 bg-indigo-600 rounded mr-2"></div>
            <span class="text-gray-600">Selected</span>
          </div>
        </div>

        <!-- Day Headers -->
        <div class="grid grid-cols-7 gap-1 mb-2">
          <div class="text-center text-xs font-semibold text-gray-500 py-2">Sun</div>
          <div class="text-center text-xs font-semibold text-gray-500 py-2">Mon</div>
          <div class="text-center text-xs font-semibold text-gray-500 py-2">Tue</div>
          <div class="text-center text-xs font-semibold text-gray-500 py-2">Wed</div>
          <div class="text-center text-xs font-semibold text-gray-500 py-2">Thu</div>
          <div class="text-center text-xs font-semibold text-gray-500 py-2">Fri</div>
          <div class="text-center text-xs font-semibold text-gray-500 py-2">Sat</div>
        </div>

        <!-- Calendar Grid -->
        <div class="grid grid-cols-7 gap-1">
          <div
            *ngFor="let day of calendarDays"
            (click)="selectDate(day)"
            class="calendar-day-container relative aspect-square flex items-center justify-center cursor-pointer transition-all duration-200 rounded-lg"
            [ngClass]="{
              'bg-gray-50 text-gray-400': !day.isCurrentMonth,
              'bg-white text-gray-800 hover:bg-gray-100': day.isCurrentMonth && !day.isSelected && !day.isPast && day.isAvailable,
              'bg-gray-200 text-gray-400 cursor-not-allowed': day.isPast,
              'bg-red-50 text-red-400 cursor-not-allowed': !day.isAvailable && day.isCurrentMonth && !day.isPast,
              'bg-indigo-600 text-white shadow-lg': day.isSelected,
              'ring-2 ring-blue-400': day.isToday,
              'opacity-50': !day.isCurrentMonth
            }"
          >
            <!-- Day Number -->
            <span class="text-sm font-medium z-10">{{ day.date.getDate() }}</span>
            
            <!-- Availability Indicator -->
            <div 
              *ngIf="day.isCurrentMonth && !day.isPast"
              class="absolute bottom-1 right-1 w-2 h-2 rounded-full"
              [ngClass]="{
                'bg-green-500': day.isAvailable && !day.hasBookings,
                'bg-yellow-500': day.isAvailable && day.hasBookings,
                'bg-red-500': !day.isAvailable
              }"
            ></div>
            
            <!-- Today Indicator -->
            <div 
              *ngIf="day.isToday" 
              class="absolute top-1 left-1 w-2 h-2 bg-blue-500 rounded-full"
            ></div>
          </div>
        </div>

        <!-- Selected Date Info -->
        <div *ngIf="selectedDate" class="mt-4 p-4 bg-indigo-50 rounded-lg border border-indigo-200">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-semibold text-indigo-800">Selected Date</p>
              <p class="text-indigo-700">{{ formatFullDate(selectedDate) }}</p>
            </div>
            <div class="text-right">
              <p class="text-xs text-indigo-600">{{ workerName }} is available</p>
              <p class="text-xs text-indigo-500">Choose a time slot below</p>
            </div>
          </div>
        </div>

        <!-- Worker Availability Info -->
        <div *ngIf="workerAvailability" class="mt-4 p-3 bg-blue-50 rounded-lg">
          <p class="text-sm font-semibold text-blue-800 mb-2">{{ workerName }}'s Schedule</p>
          <div class="flex flex-wrap gap-2">
            <span 
              *ngFor="let day of workerAvailability.availableDays"
              class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full capitalize"
            >
              {{ day }}
            </span>
          </div>
          <p class="text-xs text-blue-600 mt-2">
            Working hours: {{ workerAvailability.workingHours.start }} - {{ workerAvailability.workingHours.end }}
          </p>
        </div>
      </div>

      <!-- Time Slots -->
      <div *ngIf="selectedDate" class="bg-white rounded-2xl shadow-lg p-6 border border-gray-100">
        <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
          <ion-icon name="time" class="text-green-600 mr-2"></ion-icon>
          Available Times
        </h3>

        <div *ngIf="isLoadingAvailability" class="text-center py-8">
          <ion-spinner name="dots" class="text-indigo-600"></ion-spinner>
          <p class="text-gray-500 text-sm mt-2">Loading availability...</p>
        </div>

        <div *ngIf="!isLoadingAvailability" class="grid grid-cols-3 md:grid-cols-4 gap-3">
          <button
            *ngFor="let slot of timeSlots"
            (click)="selectTimeSlot(slot)"
            class="p-3 rounded-lg text-sm font-medium transition-all duration-200"
            [class]="selectedTimeSlot?.time === slot.time ? 
              'bg-indigo-600 text-white shadow-lg' : 
              slot.available ? 
                'bg-green-50 text-green-800 border border-green-200 hover:bg-green-100' : 
                'bg-red-50 text-red-800 border border-red-200 cursor-not-allowed opacity-50'"
            [disabled]="!slot.available"
          >
            {{ slot.time }}
          </button>
        </div>

        <div *ngIf="selectedTimeSlot" class="mt-4 p-3 bg-green-50 rounded-lg">
          <p class="text-sm text-green-800">
            <strong>Selected Time:</strong> {{ selectedTimeSlot.time }}
          </p>
        </div>
      </div>
    </div>

    <!-- Step 3: Booking Details -->
    <div *ngIf="currentStep === 3" class="space-y-4">
      <div class="bg-white rounded-2xl shadow-lg p-6 border border-gray-100">
        <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
          <ion-icon name="document-text" class="text-purple-600 mr-2"></ion-icon>
          Booking Details
        </h2>

        <div class="space-y-4">
          <!-- Address Selection -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-3">
              Service Address *
            </label>
            
            <!-- Saved Addresses -->
            <div *ngIf="savedAddresses.length > 0" class="mb-4">
              <h4 class="text-sm font-medium text-gray-600 mb-2">Your Saved Addresses</h4>
              <div class="space-y-2">
                <div
                  *ngFor="let address of savedAddresses" 
                  (click)="selectAddress(address)"
                  class="p-3 border rounded-lg cursor-pointer transition-all duration-200 hover:shadow-md"
                  [class]="bookingForm.selectedAddressId === address.id ? 
                    'border-indigo-500 bg-indigo-50' : 
                    'border-gray-200 hover:border-gray-300'"
                >
                  <div class="flex items-start justify-between">
                    <div class="flex-1">
                      <div class="flex items-center mb-1">
                        <span class="font-medium text-gray-800">{{ address.contactPerson }}</span>
                        <span 
                          *ngIf="address.isDefault"
                          class="ml-2 px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full"
                        >
                          Default
                        </span>
                      </div>
                      <p class="text-sm text-gray-600 mb-1">{{ address.fullAddress }}</p>
                      <p class="text-xs text-gray-500">{{ address.phoneNumber }}</p>
                    </div>
                    <div 
                      *ngIf="bookingForm.selectedAddressId === address.id"
                      class="ml-3 text-indigo-600"
                    >
                      <ion-icon name="checkmark-circle" class="text-lg"></ion-icon>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Custom Address Option -->
            <div class="mb-4">
              <button
                type="button"
                (click)="toggleCustomAddress()"
                class="flex items-center text-sm text-indigo-600 hover:text-indigo-700 font-medium"
              >
                <ion-icon 
                  [name]="useCustomAddress ? 'checkmark-circle' : 'add-circle-outline'" 
                  class="mr-2"
                ></ion-icon>
                {{ useCustomAddress ? 'Using custom address' : 'Use a different address' }}
              </button>
            </div>

            <!-- Custom Address Input -->
            <div *ngIf="useCustomAddress" class="mb-4">
              <textarea
                [(ngModel)]="bookingForm.customAddress"
                placeholder="Enter the complete address where the service will be performed"
                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 resize-none"
                rows="3"
              ></textarea>
            </div>

            <!-- Selected Address Preview -->
            <div *ngIf="getCurrentAddress()" class="p-3 bg-green-50 border border-green-200 rounded-lg">
              <div class="flex items-start">
                <ion-icon name="location" class="text-green-600 mt-1 mr-2"></ion-icon>
                <div>
                  <p class="text-sm font-medium text-green-800 mb-1">Selected Address:</p>
                  <p class="text-sm text-green-700">{{ getCurrentAddress() }}</p>
                </div>
              </div>
            </div>

            <!-- No Address Warning -->
            <div *ngIf="!getCurrentAddress()" class="p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
              <div class="flex items-start">
                <ion-icon name="warning" class="text-yellow-600 mt-1 mr-2"></ion-icon>
                <div>
                  <p class="text-sm font-medium text-yellow-800">Please select an address</p>
                  <p class="text-xs text-yellow-700">Choose from your saved addresses or enter a custom address</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Contact Number -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Contact Number
            </label>
            <input
              type="tel"
              [(ngModel)]="bookingForm.contactNumber"
              placeholder="Your contact number for this booking"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
            />
          </div>

          <!-- Additional Notes -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Additional Notes (Optional)
            </label>
            <textarea
              [(ngModel)]="bookingForm.notes"
              placeholder="Any special instructions or requirements for the worker"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 resize-none"
              rows="3"
            ></textarea>
          </div>
        </div>
      </div>
    </div>

    <!-- Step 4: Confirmation -->
    <div *ngIf="currentStep === 4" class="space-y-4">
      <div class="bg-white rounded-2xl shadow-lg p-6 border border-gray-100">
        <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
          <ion-icon name="checkmark-circle" class="text-green-600 mr-2"></ion-icon>
          Booking Summary
        </h2>

        <div class="space-y-4">
          <!-- Worker Info -->
          <div class="flex items-center space-x-4 p-4 bg-gray-50 rounded-xl">
            <div class="w-12 h-12 rounded-full overflow-hidden border-2 border-indigo-200">
              <img 
                *ngIf="worker?.profilePhotoData" 
                [src]="'data:image/jpeg;base64,' + worker?.profilePhotoData" 
                alt="Worker Profile"
                class="w-full h-full object-cover"
              />
              <div 
                *ngIf="!worker?.profilePhotoData" 
                class="w-full h-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center"
              >
                <span class="text-white text-lg font-bold">
                  {{ workerName.charAt(0).toUpperCase() }}
                </span>
              </div>
            </div>
            <div>
              <h3 class="font-semibold text-gray-800">{{ workerName }}</h3>
              <p class="text-sm text-gray-600">{{ worker?.phone || 'Professional Service Provider' }}</p>
              <div *ngIf="worker?.rating" class="flex items-center mt-1">
                <ion-icon name="star" class="text-yellow-500 mr-1 text-sm"></ion-icon>
                <span class="text-xs text-gray-600">{{ worker?.rating }}/5</span>
              </div>
            </div>
          </div>

          <!-- Service Details -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="p-4 border border-gray-200 rounded-xl">
              <h4 class="font-semibold text-gray-800 mb-2">Service</h4>
              <p class="text-gray-600">{{ selectedService?.name }}</p>
              <p class="text-sm text-gray-500">{{ selectedService?.category }}</p>
            </div>

            <div class="p-4 border border-gray-200 rounded-xl">
              <h4 class="font-semibold text-gray-800 mb-2">Price</h4>
              <p class="text-2xl font-bold text-indigo-600">â‚±{{ selectedService?.price }}</p>
              <p class="text-sm text-gray-500">{{ selectedService?.duration }} minutes</p>
            </div>

            <div class="p-4 border border-gray-200 rounded-xl">
              <h4 class="font-semibold text-gray-800 mb-2">Date</h4>
              <p class="text-gray-600">{{ selectedDate ? formatFullDate(selectedDate) : 'Not selected' }}</p>
            </div>

            <div class="p-4 border border-gray-200 rounded-xl">
              <h4 class="font-semibold text-gray-800 mb-2">Time</h4>
              <p class="text-gray-600">{{ selectedTimeSlot?.time || 'Not selected' }}</p>
            </div>
          </div>

          <!-- Address -->
          <div class="p-4 border border-gray-200 rounded-xl">
            <h4 class="font-semibold text-gray-800 mb-2">Service Address</h4>
            <p class="text-gray-600">{{ getCurrentAddress() }}</p>
          </div>

          <!-- Notes -->
          <div *ngIf="bookingForm.notes" class="p-4 border border-gray-200 rounded-xl">
            <h4 class="font-semibold text-gray-800 mb-2">Additional Notes</h4>
            <p class="text-gray-600">{{ bookingForm.notes }}</p>
          </div>

          <!-- Important Notice -->
          <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-xl">
            <div class="flex items-start">
              <ion-icon name="information-circle" class="text-yellow-600 mt-1 mr-3"></ion-icon>
              <div>
                <h4 class="font-semibold text-yellow-800 mb-1">Important Notice</h4>
                <p class="text-sm text-yellow-700">
                  Your booking will be sent to {{ workerName }} for confirmation. 
                  You will receive a notification once the worker accepts or declines your request.
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Fixed Bottom Navigation -->
  <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-4 shadow-lg">
    <div class="flex space-x-3 max-w-md mx-auto">
      <button
        *ngIf="currentStep > 1"
        (click)="previousStep()"
        class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-800 py-3 px-4 rounded-xl font-semibold text-sm transition-all duration-200 flex items-center justify-center"
      >
        <ion-icon name="chevron-back" class="mr-2"></ion-icon>
        Previous
      </button>
      
      <button
        *ngIf="currentStep < totalSteps"
        (click)="nextStep()"
        class="flex-2 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white py-3 px-6 rounded-xl font-semibold text-sm transition-all duration-200 flex items-center justify-center shadow-lg"
      >
        Next
        <ion-icon name="chevron-forward" class="ml-2"></ion-icon>
      </button>
      
      <button
        *ngIf="currentStep === totalSteps"
        (click)="confirmBooking()"
        class="flex-2 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white py-3 px-6 rounded-xl font-semibold text-sm transition-all duration-200 flex items-center justify-center shadow-lg"
      >
        <ion-icon name="checkmark" class="mr-2"></ion-icon>
        Confirm Booking
      </button>
    </div>
  </div>
</ion-content>