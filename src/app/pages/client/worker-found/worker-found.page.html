<!-- =============================================================== -->
<!-- ðŸ§  HandyHome App â€“ Worker Found Page UI Implementation -->
<!-- =============================================================== -->
<!-- Framework: Ionic Angular + Firebase + Tailwind CSS -->
<!-- Goal: Show worker info, real-time location, status updates, -->
<!--       payment summary, and progress tracking -->
<!-- =============================================================== -->

<ion-content
  [fullscreen]="true"
  class="bg-gradient-to-br from-green-50 via-white to-emerald-50"
>
  <!-- Custom Header -->
  <div
    class="bg-gradient-to-r from-green-600 via-emerald-600 to-teal-600 pt-12 pb-6 px-6 rounded-bl-3xl rounded-br-3xl shadow-xl mb-6 relative overflow-hidden"
  >
    <!-- Background Pattern -->
    <div class="absolute inset-0 opacity-10">
      <div
        class="absolute top-0 left-0 w-32 h-32 bg-white rounded-full -translate-x-16 -translate-y-16"
      ></div>
      <div
        class="absolute top-8 right-8 w-20 h-20 bg-white rounded-full opacity-20"
      ></div>
      <div
        class="absolute bottom-0 right-0 w-40 h-40 bg-white rounded-full translate-x-20 translate-y-20"
      ></div>
    </div>

    <div class="relative z-10">
      <div class="flex items-center justify-between mb-3">
        <div class="flex items-center space-x-4">
          <button
            (click)="goBack()"
            class="p-2 rounded-xl bg-white/20 hover:bg-white/30 transition-all duration-200 backdrop-blur-sm"
          >
            <ion-icon name="arrow-back" class="text-white text-xl"></ion-icon>
          </button>
          <div>
            <h1 class="text-white text-2xl font-bold">Worker Found!</h1>
            <p class="text-green-100 text-sm">
              Your HandyHome professional is ready
            </p>
          </div>
        </div>
        <div class="flex items-center space-x-2">
          <button
            (click)="callWorker()"
            class="p-2 rounded-xl bg-white/20 hover:bg-white/30 transition-all duration-200 backdrop-blur-sm"
          >
            <ion-icon name="call" class="text-white text-xl"></ion-icon>
          </button>
          <button
            (click)="messageWorker()"
            class="p-2 rounded-xl bg-white/20 hover:bg-white/30 transition-all duration-200 backdrop-blur-sm"
          >
            <ion-icon name="chatbubble" class="text-white text-xl"></ion-icon>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="flex flex-col items-center justify-center p-8">
    <div
      class="w-16 h-16 bg-gradient-to-br from-green-100 to-emerald-100 rounded-full flex items-center justify-center mb-4 animate-pulse"
    >
      <ion-icon name="person-add" class="text-2xl text-green-600"></ion-icon>
    </div>
    <h3 class="text-lg font-semibold text-gray-800 mb-2">
      Finding Your Worker
    </h3>
    <p class="text-gray-600 text-sm text-center">
      Loading worker details and location...
    </p>
  </div>

  <!-- Worker Found Content -->
  <div *ngIf="!isLoading && workerData && bookingData" class="p-4 space-y-6">
    <!-- =============================================================== -->
    <!-- ðŸ§© Worker Information Card -->
    <!-- =============================================================== -->
    <div class="bg-white rounded-2xl shadow-lg p-6 border border-green-100">
      <div class="flex items-center space-x-4 mb-4">
        <!-- Worker Avatar -->
        <div class="relative">
          <div
            class="w-20 h-20 bg-gradient-to-br from-green-100 to-emerald-100 rounded-full flex items-center justify-center overflow-hidden border-2 border-green-200"
          >
            <img
              *ngIf="hasWorkerProfileImage()"
              [src]="getWorkerProfileImageSrc()"
              [alt]="workerData.fullName"
              class="w-full h-full object-cover"
              (error)="onImageError($event)"
            />
            <span
              *ngIf="!hasWorkerProfileImage()"
              class="text-green-600 font-bold text-2xl"
              >{{ getWorkerInitials() }}</span
            >
          </div>
          <!-- Verification Badge -->
          <div
            *ngIf="workerData.verificationStatus === 'verified'"
            class="absolute -bottom-1 -right-1 bg-green-500 rounded-full p-2 border-2 border-white"
          >
            <ion-icon name="checkmark" class="text-white text-sm"></ion-icon>
          </div>
        </div>

        <!-- Worker Info -->
        <div class="flex-1">
          <h3 class="text-xl font-bold text-gray-800">
            {{ workerData.fullName }}
          </h3>
          <p class="text-sm text-gray-600 mb-1">
            {{ workerData.skills.join(', ') }}
          </p>
          <div class="flex items-center space-x-3">
            <div class="flex items-center" *ngIf="workerData.rating">
              <ion-icon
                name="star"
                class="text-yellow-500 text-sm mr-1"
              ></ion-icon>
              <span class="text-sm text-gray-600"
                >{{ workerData.rating | number:'1.1-1' }}</span
              >
            </div>
            <span
              class="text-xs text-green-600 bg-green-100 px-2 py-1 rounded-full"
              >{{ workerData.totalJobs }} jobs completed</span
            >
          </div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="grid grid-cols-2 gap-3">
        <button
          (click)="callWorker()"
          class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white p-3 rounded-xl font-semibold text-sm shadow-lg transform hover:scale-105 transition-all duration-300 flex items-center justify-center"
        >
          <ion-icon name="call" class="mr-2"></ion-icon>
          Call Worker
        </button>
        <button
          (click)="messageWorker()"
          class="bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white p-3 rounded-xl font-semibold text-sm shadow-lg transform hover:scale-105 transition-all duration-300 flex items-center justify-center"
        >
          <ion-icon name="chatbubble" class="mr-2"></ion-icon>
          Message
        </button>
      </div>
    </div>

    <!-- =============================================================== -->
    <!-- ðŸ“Š Booking Status Card -->
    <!-- =============================================================== -->
    <div
      class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-2xl p-6 shadow-lg"
    >
      <div class="flex items-center mb-3">
        <ion-icon name="information-circle" class="text-2xl mr-3"></ion-icon>
        <h4 class="font-bold text-lg">Booking Status</h4>
      </div>
      <p class="text-blue-100 text-sm mb-4">{{ bookingStatusMessage }}</p>

      <!-- Progress Tracker -->
      <div class="flex items-center justify-between text-xs text-blue-200">
        <div class="flex flex-col items-center">
          <div
            [class]="bookingData.status === 'accepted' ? 'bg-white text-blue-600' : 'bg-blue-400/50'"
            class="w-8 h-8 rounded-full flex items-center justify-center mb-1"
          >
            <ion-icon name="checkmark"></ion-icon>
          </div>
          <span>Accepted</span>
        </div>
        <div
          class="flex-1 h-0.5 bg-blue-400/50 mx-2"
          [class.bg-white]="['on_the_way', 'in_progress', 'completed'].includes(bookingData.status)"
        ></div>
        <div class="flex flex-col items-center">
          <div
            [class]="['on_the_way', 'in_progress', 'completed'].includes(bookingData.status) ? 'bg-white text-blue-600' : 'bg-blue-400/50'"
            class="w-8 h-8 rounded-full flex items-center justify-center mb-1"
          >
            <ion-icon name="car"></ion-icon>
          </div>
          <span>On the Way</span>
        </div>
        <div
          class="flex-1 h-0.5 bg-blue-400/50 mx-2"
          [class.bg-white]="['in_progress', 'completed'].includes(bookingData.status)"
        ></div>
        <div class="flex flex-col items-center">
          <div
            [class]="['in_progress', 'completed'].includes(bookingData.status) ? 'bg-white text-blue-600' : 'bg-blue-400/50'"
            class="w-8 h-8 rounded-full flex items-center justify-center mb-1"
          >
            <ion-icon name="construct"></ion-icon>
          </div>
          <span>Working</span>
        </div>
        <div
          class="flex-1 h-0.5 bg-blue-400/50 mx-2"
          [class.bg-white]="bookingData.status === 'completed'"
        ></div>
        <div class="flex flex-col items-center">
          <div
            [class]="bookingData.status === 'completed' ? 'bg-white text-blue-600' : 'bg-blue-400/50'"
            class="w-8 h-8 rounded-full flex items-center justify-center mb-1"
          >
            <ion-icon name="checkmark-done"></ion-icon>
          </div>
          <span>Done</span>
        </div>
      </div>
    </div>

    <!-- =============================================================== -->
    <!-- ðŸ—ºï¸ "Where Is He" Card with Map -->
    <!-- =============================================================== -->
    <div class="bg-white rounded-2xl shadow-lg p-6 border border-green-100">
      <div class="flex items-center justify-between mb-4">
        <h4 class="font-bold text-lg text-gray-800">Where is the worker?</h4>
        <button
          (click)="refreshWorkerLocation()"
          class="bg-green-100 hover:bg-green-200 text-green-600 px-3 py-2 rounded-lg text-sm font-semibold transition-all duration-200 flex items-center"
        >
          <ion-icon name="refresh" class="mr-1"></ion-icon>
          Refresh
        </button>
      </div>

      <p class="text-gray-600 text-sm mb-4">{{ workerDistanceMessage }}</p>

      <!-- Distance and ETA Info -->
      <div *ngIf="trackingData" class="bg-gray-50 rounded-xl p-4 mb-4">
        <div class="grid grid-cols-2 gap-4">
          <div class="text-center">
            <div class="text-2xl font-bold text-green-600">
              {{ getFormattedDistance() }}
            </div>
            <div class="text-xs text-gray-500">Distance</div>
          </div>
          <div class="text-center">
            <div
              class="text-2xl font-bold"
              [class]="'text-' + getETAColor() + '-600'"
            >
              {{ trackingData.estimatedTravelTime || 0 }}m
            </div>
            <div class="text-xs text-gray-500">ETA</div>
          </div>
        </div>
      </div>

      <!-- Map Container -->
      <div
        class="w-full h-64 bg-gray-100 rounded-xl overflow-hidden shadow-inner relative"
      >
        <div *ngIf="!showMap" class="flex items-center justify-center h-full">
          <div class="text-center">
            <ion-icon name="map" class="text-4xl text-gray-400 mb-2"></ion-icon>
            <p class="text-gray-500 text-sm">Loading map...</p>
          </div>
        </div>

        <!-- TODO: Add Google Maps component here -->
        <div *ngIf="showMap" id="workerLocationMap" class="w-full h-full"></div>
      </div>

      <p class="text-xs text-gray-400 mt-2 text-center">
        Last updated: {{ getLastUpdateTime() }}
      </p>
    </div>

    <!-- =============================================================== -->
    <!-- ðŸ’° Payment Summary Card -->
    <!-- =============================================================== -->
    <div class="bg-white rounded-2xl shadow-lg p-6 border border-green-100">
      <div class="flex items-center mb-4">
        <ion-icon
          name="calculator"
          class="text-2xl text-green-600 mr-3"
        ></ion-icon>
        <h4 class="font-bold text-lg text-gray-800">Payment Summary</h4>
      </div>

      <div class="space-y-3">
        <div class="flex justify-between text-sm">
          <span class="text-gray-600"
            >Service ({{ bookingData.categoryName }})</span
          >
          <span class="font-semibold text-gray-800"
            >â‚±{{ bookingData.pricing.basePrice | number:'1.2-2' }}</span
          >
        </div>
        <div class="flex justify-between text-sm">
          <span class="text-gray-600">Service Charge</span>
          <span class="font-semibold text-gray-800"
            >â‚±{{ bookingData.pricing.serviceCharge | number:'1.2-2' }}</span
          >
        </div>
        <div class="flex justify-between text-sm">
          <span class="text-gray-600">Transport Fee</span>
          <span class="font-semibold text-gray-800"
            >â‚±{{ bookingData.pricing.transportFee | number:'1.2-2' }}</span
          >
        </div>
        <div class="border-t border-gray-200 pt-3 mt-3">
          <div class="flex justify-between font-bold text-lg">
            <span class="text-gray-800">Total Amount</span>
            <span class="text-green-700 bg-green-100 px-3 py-1 rounded-lg"
              >â‚±{{ bookingData.pricing.total | number:'1.2-2' }}</span
            >
          </div>
        </div>
      </div>

      <!-- Payment Status/Action Section -->
      <div
        class="mt-4"
        *ngIf="bookingData.status === 'completed' && !bookingData.paymentDetails?.status"
      >
        <button
          (click)="processPayment()"
          class="w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white p-4 rounded-xl font-semibold text-lg shadow-lg transform hover:scale-105 transition-all duration-300 flex items-center justify-center"
        >
          <ion-icon name="card" class="mr-3 text-xl"></ion-icon>
          Pay Now - â‚±{{ bookingData.pricing.total | number:'1.2-2' }}
        </button>
        <p class="text-xs text-gray-600 text-center mt-2">
          <ion-icon name="shield-checkmark" class="mr-1"></ion-icon>
          Secure Cash on Service payment
        </p>
      </div>

      <!-- Payment Completed -->
      <div
        class="mt-4 p-3 bg-green-50 rounded-lg"
        *ngIf="bookingData.paymentDetails?.status === 'completed'"
      >
        <div
          class="flex items-center justify-center text-green-700 font-semibold mb-2"
        >
          <ion-icon name="checkmark-circle" class="mr-2 text-lg"></ion-icon>
          Payment Completed
        </div>
        <p class="text-xs text-green-600 text-center">
          Receipt ID: {{ bookingData.paymentDetails?.receiptId }}
        </p>
      </div>

      <!-- Payment Pending (Before Completion) -->
      <div
        class="mt-4 p-3 bg-blue-50 rounded-lg"
        *ngIf="bookingData.status !== 'completed'"
      >
        <p class="text-xs text-blue-700">
          <ion-icon name="information-circle" class="mr-1"></ion-icon>Payment
          will be processed after service completion
        </p>
      </div>
    </div>

    <!-- =============================================================== -->
    <!-- ðŸ“ Job Details Card -->
    <!-- =============================================================== -->
    <div class="bg-white rounded-2xl shadow-lg p-6 border border-green-100">
      <h4 class="font-bold text-lg text-gray-800 mb-4">Job Details</h4>

      <div class="space-y-3">
        <div class="flex items-start">
          <ion-icon
            name="construct"
            class="text-green-600 mt-1 mr-3"
          ></ion-icon>
          <div>
            <p class="font-semibold text-gray-800">
              {{ bookingData.subService }}
            </p>
            <p class="text-sm text-gray-600">{{ bookingData.categoryName }}</p>
          </div>
        </div>

        <div class="flex items-start">
          <ion-icon name="location" class="text-blue-600 mt-1 mr-3"></ion-icon>
          <div>
            <p class="font-semibold text-gray-800">Service Location</p>
            <p class="text-sm text-gray-600">
              {{ bookingData.location.address }}
            </p>
          </div>
        </div>

        <div class="flex items-start">
          <ion-icon name="time" class="text-purple-600 mt-1 mr-3"></ion-icon>
          <div>
            <p class="font-semibold text-gray-800">Estimated Duration</p>
            <p class="text-sm text-gray-600">
              {{ bookingData.estimatedDuration }}
            </p>
          </div>
        </div>

        <div class="flex items-start">
          <ion-icon
            name="calendar"
            class="text-orange-600 mt-1 mr-3"
          ></ion-icon>
          <div>
            <p class="font-semibold text-gray-800">Booking Created</p>
            <p class="text-sm text-gray-600">
              {{ bookingData.createdAt?.toDate() | date:'short' }}
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- =============================================================== -->
    <!-- ðŸš¨ Emergency & Help Section -->
    <!-- =============================================================== -->
    <div class="bg-red-50 border border-red-200 rounded-2xl p-4">
      <div class="flex items-center mb-2">
        <ion-icon name="warning" class="text-red-500 mr-2"></ion-icon>
        <h5 class="font-semibold text-red-800">Need Help?</h5>
      </div>
      <p class="text-sm text-red-700 mb-3">
        If you have any issues or concerns with this worker, you can report them
        or contact HandyHome support.
      </p>
      <div class="flex space-x-2">
        <button
          (click)="reportWorker()"
          class="flex-1 bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-all duration-200 flex items-center justify-center"
        >
          <ion-icon name="flag" class="mr-2"></ion-icon>
          Report Worker
        </button>
        <button
          class="flex-1 bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-all duration-200 flex items-center justify-center"
        >
          <ion-icon name="call" class="mr-2"></ion-icon>
          Emergency Support
        </button>
      </div>
    </div>
  </div>

  <!-- Error State -->
  <div
    *ngIf="!isLoading && (!workerData || !bookingData)"
    class="flex flex-col items-center justify-center p-8"
  >
    <div
      class="w-16 h-16 bg-gradient-to-br from-red-100 to-red-200 rounded-full flex items-center justify-center mb-4"
    >
      <ion-icon name="alert-circle" class="text-2xl text-red-600"></ion-icon>
    </div>
    <h3 class="text-lg font-semibold text-gray-800 mb-2">
      Unable to Load Worker Details
    </h3>
    <p class="text-gray-600 text-sm text-center mb-4">
      Please check your connection and try again.
    </p>
    <button
      (click)="initializeBookingTracking()"
      class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-xl font-semibold text-sm shadow-lg transform hover:scale-105 transition-all duration-300 flex items-center"
    >
      <ion-icon name="refresh" class="mr-2"></ion-icon>
      Retry
    </button>
  </div>
</ion-content>
